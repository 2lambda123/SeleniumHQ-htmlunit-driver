


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > HtmlUnitDriver</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.openqa.selenium.htmlunit</a>
</div>

<h1>Coverage Summary for Class: HtmlUnitDriver (org.openqa.selenium.htmlunit)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">HtmlUnitDriver</td>
<td class="coverageStat">
  <span class="percent">
    83.3%
  </span>
  <span class="absValue">
    (65/78)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    47.2%
  </span>
  <span class="absValue">
    (102/216)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    62.7%
  </span>
  <span class="absValue">
    (294/469)
  </span>
</td>
</tr>
  <tr>
    <td class="name">HtmlUnitDriver$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    85.7%
  </span>
  <span class="absValue">
    (12/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (16/16)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HtmlUnitDriver$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HtmlUnitDriver$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HtmlUnitDriver$ElementsMap</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (12/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HtmlUnitDriver$HtmlUnitNavigation</td>
<td class="coverageStat">
  <span class="percent">
    55.6%
  </span>
  <span class="absValue">
    (5/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    33.3%
  </span>
  <span class="absValue">
    (7/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HtmlUnitDriver$JavaScriptResultsCollection</td>
  </tr>
  <tr>
    <td class="name">HtmlUnitDriver$PageLoadStrategy</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    77.2%
  </span>
  <span class="absValue">
    (78/101)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    49.6%
  </span>
  <span class="absValue">
    (116/234)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    62.9%
  </span>
  <span class="absValue">
    (331/526)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;// Licensed to the Software Freedom Conservancy (SFC) under one
&nbsp;// or more contributor license agreements.  See the NOTICE file
&nbsp;// distributed with this work for additional information
&nbsp;// regarding copyright ownership.  The SFC licenses this file
&nbsp;// to you under the Apache License, Version 2.0 (the
&nbsp;// &quot;License&quot;); you may not use this file except in compliance
&nbsp;// with the License.  You may obtain a copy of the License at
&nbsp;//
&nbsp;//   http://www.apache.org/licenses/LICENSE-2.0
&nbsp;//
&nbsp;// Unless required by applicable law or agreed to in writing,
&nbsp;// software distributed under the License is distributed on an
&nbsp;// &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
&nbsp;// KIND, either express or implied.  See the License for the
&nbsp;// specific language governing permissions and limitations
&nbsp;// under the License.
&nbsp;
&nbsp;package org.openqa.selenium.htmlunit;
&nbsp;
&nbsp;import static org.openqa.selenium.remote.Browser.HTMLUNIT;
&nbsp;import static org.openqa.selenium.remote.CapabilityType.ACCEPT_INSECURE_CERTS;
&nbsp;import static org.openqa.selenium.remote.CapabilityType.PAGE_LOAD_STRATEGY;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.lang.reflect.Field;
&nbsp;import java.net.ConnectException;
&nbsp;import java.net.SocketTimeoutException;
&nbsp;import java.net.URL;
&nbsp;import java.net.UnknownHostException;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.time.Instant;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Map.Entry;
&nbsp;import java.util.Set;
&nbsp;import java.util.WeakHashMap;
&nbsp;import java.util.concurrent.Callable;
&nbsp;import java.util.concurrent.Executor;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.Executors;
&nbsp;import java.util.concurrent.locks.Condition;
&nbsp;import java.util.concurrent.locks.Lock;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;
&nbsp;import javax.net.ssl.SSLHandshakeException;
&nbsp;
&nbsp;import org.htmlunit.BrowserVersion;
&nbsp;import org.htmlunit.Page;
&nbsp;import org.htmlunit.ProxyConfig;
&nbsp;import org.htmlunit.ScriptResult;
&nbsp;import org.htmlunit.SgmlPage;
&nbsp;import org.htmlunit.StringWebResponse;
&nbsp;import org.htmlunit.TopLevelWindow;
&nbsp;import org.htmlunit.UnexpectedPage;
&nbsp;import org.htmlunit.Version;
&nbsp;import org.htmlunit.WaitingRefreshHandler;
&nbsp;import org.htmlunit.WebClient;
&nbsp;import org.htmlunit.WebClientOptions;
&nbsp;import org.htmlunit.WebRequest;
&nbsp;import org.htmlunit.WebResponse;
&nbsp;import org.htmlunit.WebWindow;
&nbsp;import org.htmlunit.WebWindowEvent;
&nbsp;import org.htmlunit.WebWindowListener;
&nbsp;import org.htmlunit.corejs.javascript.Context;
&nbsp;import org.htmlunit.corejs.javascript.IdScriptableObject;
&nbsp;import org.htmlunit.corejs.javascript.NativeArray;
&nbsp;import org.htmlunit.corejs.javascript.NativeObject;
&nbsp;import org.htmlunit.corejs.javascript.Scriptable;
&nbsp;import org.htmlunit.corejs.javascript.Undefined;
&nbsp;import org.htmlunit.html.DomElement;
&nbsp;import org.htmlunit.html.DomNode;
&nbsp;import org.htmlunit.html.FrameWindow;
&nbsp;import org.htmlunit.html.HtmlElement;
&nbsp;import org.htmlunit.html.HtmlPage;
&nbsp;import org.htmlunit.javascript.host.Element;
&nbsp;import org.htmlunit.javascript.host.Location;
&nbsp;import org.htmlunit.javascript.host.html.DocumentProxy;
&nbsp;import org.htmlunit.javascript.host.html.HTMLCollection;
&nbsp;import org.htmlunit.javascript.host.html.HTMLElement;
&nbsp;import org.htmlunit.platform.AwtClipboardHandler;
&nbsp;import org.htmlunit.util.UrlUtils;
&nbsp;import org.openqa.selenium.By;
&nbsp;import org.openqa.selenium.Capabilities;
&nbsp;import org.openqa.selenium.HasCapabilities;
&nbsp;import org.openqa.selenium.JavascriptExecutor;
&nbsp;import org.openqa.selenium.NoSuchSessionException;
&nbsp;import org.openqa.selenium.NoSuchWindowException;
&nbsp;import org.openqa.selenium.Platform;
&nbsp;import org.openqa.selenium.Proxy;
&nbsp;import org.openqa.selenium.StaleElementReferenceException;
&nbsp;import org.openqa.selenium.TimeoutException;
&nbsp;import org.openqa.selenium.WebDriver;
&nbsp;import org.openqa.selenium.WebDriverException;
&nbsp;import org.openqa.selenium.WebElement;
&nbsp;import org.openqa.selenium.WrapsElement;
&nbsp;import org.openqa.selenium.htmlunit.w3.Action;
&nbsp;import org.openqa.selenium.htmlunit.w3.Algorithms;
&nbsp;import org.openqa.selenium.interactions.Interactive;
&nbsp;import org.openqa.selenium.interactions.Sequence;
&nbsp;import org.openqa.selenium.remote.Browser;
&nbsp;import org.openqa.selenium.remote.DesiredCapabilities;
&nbsp;
&nbsp;/**
&nbsp; * An implementation of {@link WebDriver} that drives
&nbsp; * &lt;a href=&quot;https://www.htmlunit.org&quot;&gt;HtmlUnit&lt;/a&gt;, which is a headless
&nbsp; * (GUI-less) browser simulator.
&nbsp; * &lt;p&gt;
&nbsp; * The main supported browsers are Chrome, Edge, Firefox and Internet Explorer.
&nbsp; *
&nbsp; * @author Alexei Barantsev
&nbsp; * @author Ahmed Ashour
&nbsp; * @author Rafael Jimenez
&nbsp; * @author Luke Inman-Semerau
&nbsp; * @author Kay McCormick
&nbsp; * @author Simon Stewart
&nbsp; * @author Javier Neira
&nbsp; * @author Ronald Brill
&nbsp; * @author Rob Winch
&nbsp; * @author Andrei Solntsev
&nbsp; * @author Martin Barto≈°
&nbsp; */
<b class="fc">&nbsp;public class HtmlUnitDriver implements WebDriver, JavascriptExecutor, HasCapabilities, Interactive {</b>
&nbsp;
&nbsp;    private static final int sleepTime = 200;
&nbsp;
<b class="fc">&nbsp;    private WebClient webClient_;</b>
&nbsp;    private final HtmlUnitAlert alert_;
<b class="fc">&nbsp;    private HtmlUnitWindow currentWindow_;</b>
&nbsp;    private HtmlUnitKeyboard keyboard_;
&nbsp;    private HtmlUnitMouse mouse_;
&nbsp;    private final TargetLocator targetLocator_;
&nbsp;    private AsyncScriptExecutor asyncScriptExecutor_;
<b class="fc">&nbsp;    private PageLoadStrategy pageLoadStrategy_ = PageLoadStrategy.NORMAL;</b>
<b class="fc">&nbsp;    private final ElementsMap elementsMap_ = new ElementsMap();</b>
&nbsp;    private final Options options_;
&nbsp;
&nbsp;    private final HtmlUnitElementFinder elementFinder_;
<b class="fc">&nbsp;    private HtmlUnitInputProcessor inputProcessor_ = new HtmlUnitInputProcessor(this);</b>
&nbsp;
&nbsp;    /** BROWSER_LANGUAGE_CAPABILITY = &quot;browserLanguage&quot;. */
&nbsp;    public static final String BROWSER_LANGUAGE_CAPABILITY = &quot;browserLanguage&quot;;
&nbsp;
&nbsp;    /** DOWNLOAD_IMAGES_CAPABILITY = &quot;downloadImages&quot;. */
&nbsp;    public static final String DOWNLOAD_IMAGES_CAPABILITY = &quot;downloadImages&quot;;
&nbsp;
&nbsp;    /** JAVASCRIPT_ENABLED = &quot;javascriptEnabled&quot;. */
&nbsp;    public static final String JAVASCRIPT_ENABLED = &quot;javascriptEnabled&quot;;
&nbsp;
&nbsp;    /**
&nbsp;     * The Lock for the {@link #mainCondition_}, which waits at the end of
&nbsp;     * {@link #runAsync(Runnable)} till either and alert is triggered, or
&nbsp;     * {@link Runnable} finishes.
&nbsp;     */
<b class="fc">&nbsp;    private final Lock conditionLock_ = new ReentrantLock();</b>
<b class="fc">&nbsp;    private final Condition mainCondition_ = conditionLock_.newCondition();</b>
&nbsp;    private boolean runAsyncRunning_;
&nbsp;    private RuntimeException exception_;
&nbsp;    private final ExecutorService defaultExecutor_;
&nbsp;    private Executor executor_;
&nbsp;
&nbsp;    /**
&nbsp;     * Constructs a new instance with JavaScript disabled, and the
&nbsp;     * {@link BrowserVersion#getDefault() default} BrowserVersion.
&nbsp;     */
&nbsp;    public HtmlUnitDriver() {
<b class="fc">&nbsp;        this(BrowserVersion.getDefault(), false);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Constructs a new instance with the specified {@link BrowserVersion}.
&nbsp;     *
&nbsp;     * @param version the browser version to use
&nbsp;     */
&nbsp;    public HtmlUnitDriver(final BrowserVersion version) {
<b class="fc">&nbsp;        this(version, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Constructs a new instance, specify JavaScript support and using the
&nbsp;     * {@link BrowserVersion#getDefault() default} BrowserVersion.
&nbsp;     *
&nbsp;     * @param enableJavascript whether to enable JavaScript support or not
&nbsp;     */
&nbsp;    public HtmlUnitDriver(final boolean enableJavascript) {
<b class="fc">&nbsp;        this(BrowserVersion.getDefault(), enableJavascript);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Constructs a new instance with the specified {@link BrowserVersion} and the
&nbsp;     * JavaScript support.
&nbsp;     *
&nbsp;     * @param version          the browser version to use
&nbsp;     * @param enableJavascript whether to enable JavaScript support or not
&nbsp;     */
&nbsp;    public HtmlUnitDriver(final BrowserVersion version, final boolean enableJavascript) {
<b class="fc">&nbsp;        this(version, enableJavascript, null);</b>
&nbsp;
<b class="fc">&nbsp;        modifyWebClient(webClient_);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * The browserName is {@link Browser#HTMLUNIT} &quot;htmlunit&quot; and the
&nbsp;     * browserVersion denotes the required browser AND its version. For example
&nbsp;     * &quot;chrome&quot; for Chrome, &quot;firefox-100&quot; for Firefox 100 or &quot;internet explorer&quot; for
&nbsp;     * IE.
&nbsp;     *
&nbsp;     * @param capabilities desired capabilities requested for the htmlunit driver
&nbsp;     *                     session
&nbsp;     */
&nbsp;    public HtmlUnitDriver(final Capabilities capabilities) {
<b class="fc">&nbsp;        this(BrowserVersionDeterminer.determine(capabilities),</b>
<b class="fc">&nbsp;                capabilities.getCapability(JAVASCRIPT_ENABLED) == null || capabilities.is(JAVASCRIPT_ENABLED),</b>
<b class="fc">&nbsp;                Proxy.extractFrom(capabilities));</b>
&nbsp;
<b class="fc">&nbsp;        setDownloadImages(capabilities.is(DOWNLOAD_IMAGES_CAPABILITY));</b>
&nbsp;
<b class="pc">&nbsp;        if (alert_ != null) {</b>
<b class="fc">&nbsp;            alert_.handleBrowserCapabilities(capabilities);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Boolean acceptInsecureCerts = (Boolean) capabilities.getCapability(ACCEPT_INSECURE_CERTS);</b>
<b class="pc">&nbsp;        if (acceptInsecureCerts == null) {</b>
<b class="fc">&nbsp;            acceptInsecureCerts = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        setAcceptInsecureCerts(acceptInsecureCerts);</b>
&nbsp;
<b class="fc">&nbsp;        final String pageLoadStrategyString = (String) capabilities.getCapability(PAGE_LOAD_STRATEGY);</b>
<b class="pc">&nbsp;        if (&quot;none&quot;.equals(pageLoadStrategyString)) {</b>
<b class="nc">&nbsp;            pageLoadStrategy_ = PageLoadStrategy.NONE;</b>
<b class="nc">&nbsp;        }</b>
<b class="pc">&nbsp;        else if (&quot;eager&quot;.equals(pageLoadStrategyString)) {</b>
<b class="nc">&nbsp;            pageLoadStrategy_ = PageLoadStrategy.EAGER;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        modifyWebClient(webClient_);</b>
&nbsp;    }
&nbsp;
&nbsp;    public HtmlUnitDriver(final Capabilities desiredCapabilities, final Capabilities requiredCapabilities) {
<b class="nc">&nbsp;        this(new DesiredCapabilities(desiredCapabilities, requiredCapabilities));</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private HtmlUnitDriver(final BrowserVersion version, final boolean enableJavascript, final Proxy proxy) {</b>
<b class="fc">&nbsp;        webClient_ = newWebClient(version);</b>
&nbsp;
<b class="fc">&nbsp;        final WebClientOptions clientOptions = webClient_.getOptions();</b>
<b class="fc">&nbsp;        clientOptions.setHomePage(UrlUtils.URL_ABOUT_BLANK.toString());</b>
<b class="fc">&nbsp;        clientOptions.setThrowExceptionOnFailingStatusCode(false);</b>
<b class="fc">&nbsp;        clientOptions.setPrintContentOnFailingStatusCode(false);</b>
<b class="fc">&nbsp;        clientOptions.setRedirectEnabled(true);</b>
<b class="fc">&nbsp;        clientOptions.setUseInsecureSSL(true);</b>
&nbsp;
<b class="fc">&nbsp;        setJavascriptEnabled(enableJavascript);</b>
<b class="fc">&nbsp;        setProxySettings(proxy);</b>
&nbsp;
<b class="fc">&nbsp;        webClient_.setRefreshHandler(new WaitingRefreshHandler());</b>
<b class="fc">&nbsp;        webClient_.setClipboardHandler(new AwtClipboardHandler());</b>
&nbsp;
<b class="fc">&nbsp;        elementFinder_ = new HtmlUnitElementFinder();</b>
&nbsp;
<b class="fc">&nbsp;        alert_ = new HtmlUnitAlert(this);</b>
<b class="fc">&nbsp;        currentWindow_ = new HtmlUnitWindow(webClient_.getCurrentWindow());</b>
&nbsp;
<b class="fc">&nbsp;        defaultExecutor_ = Executors.newCachedThreadPool();</b>
<b class="fc">&nbsp;        executor_ = defaultExecutor_;</b>
&nbsp;
&nbsp;        // Now put us on the home page, like a real browser
<b class="fc">&nbsp;        get(clientOptions.getHomePage());</b>
&nbsp;
<b class="fc">&nbsp;        options_ = new HtmlUnitOptions(this);</b>
<b class="fc">&nbsp;        targetLocator_ = new HtmlUnitTargetLocator(this);</b>
&nbsp;
<b class="fc">&nbsp;        webClient_.addWebWindowListener(new WebWindowListener() {</b>
&nbsp;            @Override
&nbsp;            public void webWindowOpened(final WebWindowEvent webWindowEvent) {
<b class="fc">&nbsp;                if (webWindowEvent.getWebWindow() instanceof TopLevelWindow) {</b>
&nbsp;                    // use the first top level window we are getting aware of
<b class="pc">&nbsp;                    if (currentWindow_ == null &amp;&amp; webClient_.getTopLevelWindows().size() == 1) {</b>
<b class="fc">&nbsp;                        currentWindow_ = new HtmlUnitWindow(webClient_.getTopLevelWindows().get(0));</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void webWindowContentChanged(final WebWindowEvent event) {
<b class="fc">&nbsp;                elementsMap_.remove(event.getOldPage());</b>
<b class="fc">&nbsp;                if (event.getWebWindow() != currentWindow_.getWebWindow()) {</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
&nbsp;                // Do we need to pick some new default content?
<b class="fc">&nbsp;                switchToDefaultContentOfWindow(currentWindow_.getWebWindow());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void webWindowClosed(final WebWindowEvent event) {
<b class="fc">&nbsp;                elementsMap_.remove(event.getOldPage());</b>
&nbsp;
&nbsp;                // the last window is gone
<b class="fc">&nbsp;                if (getWebClient().getTopLevelWindows().size() == 0) {</b>
<b class="fc">&nbsp;                    currentWindow_ = null;</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
&nbsp;                // Check if the event window refers to us or one of our parent windows
&nbsp;                // setup the currentWindow appropriately if necessary
<b class="fc">&nbsp;                WebWindow ourCurrentWindow = currentWindow_.getWebWindow();</b>
<b class="fc">&nbsp;                final WebWindow ourCurrentTopWindow = currentWindow_.getWebWindow().getTopWindow();</b>
&nbsp;                do {
&nbsp;                    // Instance equality is okay in this case
<b class="fc">&nbsp;                    if (ourCurrentWindow == event.getWebWindow()) {</b>
<b class="fc">&nbsp;                        setCurrentWindow(ourCurrentTopWindow);</b>
&nbsp;                        return;
&nbsp;                    }
<b class="fc">&nbsp;                    ourCurrentWindow = ourCurrentWindow.getParentWindow();</b>
&nbsp;                }
<b class="pc">&nbsp;                while (ourCurrentWindow != ourCurrentTopWindow);</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="fc">&nbsp;        resetKeyboardAndMouseState();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return to process or not to proceed
&nbsp;     */
&nbsp;    boolean isProcessAlert() {
<b class="fc">&nbsp;        if (asyncScriptExecutor_ != null) {</b>
<b class="fc">&nbsp;            final String text = alert_.getText();</b>
<b class="fc">&nbsp;            alert_.dismiss();</b>
<b class="fc">&nbsp;            asyncScriptExecutor_.alertTriggered(text);</b>
<b class="fc">&nbsp;            return false;</b>
&nbsp;        }
<b class="fc">&nbsp;        conditionLock_.lock();</b>
&nbsp;        try {
<b class="fc">&nbsp;            mainCondition_.signal();</b>
<b class="fc">&nbsp;        }</b>
<b class="nc">&nbsp;        finally {</b>
<b class="fc">&nbsp;            conditionLock_.unlock();</b>
<b class="nc">&nbsp;        }</b>
<b class="fc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void runAsync(final Runnable r) {
<b class="pc">&nbsp;        final boolean loadStrategyWait = pageLoadStrategy_ != PageLoadStrategy.NONE;</b>
&nbsp;
<b class="pc">&nbsp;        if (loadStrategyWait) {</b>
<b class="pc">&nbsp;            while (runAsyncRunning_) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Thread.sleep(10);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                catch (final InterruptedException e) {</b>
<b class="nc">&nbsp;                    throw new RuntimeException(e);</b>
&nbsp;                }
&nbsp;            }
<b class="fc">&nbsp;            conditionLock_.lock();</b>
<b class="fc">&nbsp;            runAsyncRunning_ = true;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        exception_ = null;</b>
<b class="fc">&nbsp;        final Runnable wrapped = () -&gt; {</b>
&nbsp;            try {
<b class="fc">&nbsp;                r.run();</b>
<b class="fc">&nbsp;            }</b>
<b class="fc">&nbsp;            catch (final RuntimeException e) {</b>
<b class="fc">&nbsp;                exception_ = e;</b>
&nbsp;            }
<b class="nc">&nbsp;            finally {</b>
<b class="fc">&nbsp;                conditionLock_.lock();</b>
&nbsp;                try {
<b class="fc">&nbsp;                    runAsyncRunning_ = false;</b>
<b class="fc">&nbsp;                    mainCondition_.signal();</b>
<b class="fc">&nbsp;                }</b>
<b class="nc">&nbsp;                finally {</b>
<b class="fc">&nbsp;                    conditionLock_.unlock();</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        };
<b class="fc">&nbsp;        executor_.execute(wrapped);</b>
&nbsp;
<b class="pc">&nbsp;        if (loadStrategyWait &amp;&amp; this.runAsyncRunning_) {</b>
<b class="fc">&nbsp;            mainCondition_.awaitUninterruptibly();</b>
<b class="fc">&nbsp;            conditionLock_.unlock();</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (exception_ != null) {</b>
<b class="fc">&nbsp;            throw exception_;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void click(final DomElement element, final boolean directClick) {
<b class="fc">&nbsp;        runAsync(() -&gt; mouse_.click(element, directClick));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void doubleClick(final DomElement element) {
<b class="fc">&nbsp;        runAsync(() -&gt; mouse_.doubleClick(element));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void mouseUp(final DomElement element) {
<b class="nc">&nbsp;        runAsync(() -&gt; mouse_.mouseUp(element));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void mouseMove(final DomElement element) {
<b class="nc">&nbsp;        runAsync(() -&gt; mouse_.mouseMove(element));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void mouseDown(final DomElement element) {
<b class="nc">&nbsp;        runAsync(() -&gt; mouse_.mouseDown(element));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void submit(final HtmlUnitWebElement element) {
<b class="fc">&nbsp;        runAsync(element::submitImpl);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void sendKeys(final HtmlUnitWebElement element, final CharSequence... value) {
<b class="fc">&nbsp;        runAsync(() -&gt; keyboard_.sendKeys(element, true, value));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the simulated {@code BrowserVersion}.
&nbsp;     *
&nbsp;     * @return the used {@code BrowserVersion}
&nbsp;     */
&nbsp;    public BrowserVersion getBrowserVersion() {
<b class="fc">&nbsp;        return webClient_.getBrowserVersion();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Create the underlying WebClient, but don&#39;t set any fields on it.
&nbsp;     *
&nbsp;     * @param version Which browser to emulate
&nbsp;     * @return a new instance of WebClient.
&nbsp;     */
&nbsp;    protected WebClient newWebClient(final BrowserVersion version) {
<b class="fc">&nbsp;        return new WebClient(version);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Child classes can override this method to customize the WebClient that the
&nbsp;     * HtmlUnit driver uses.
&nbsp;     *
&nbsp;     * @param client The client to modify
&nbsp;     * @return The modified client
&nbsp;     */
&nbsp;    protected WebClient modifyWebClient(final WebClient client) {
&nbsp;        // Does nothing here to be overridden.
<b class="fc">&nbsp;        return client;</b>
&nbsp;    }
&nbsp;
&nbsp;    public HtmlUnitAlert getAlert() {
<b class="fc">&nbsp;        return alert_;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ElementsMap getElementsMap() {
<b class="fc">&nbsp;        return elementsMap_;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setCurrentWindow(final WebWindow window) {
<b class="fc">&nbsp;        if (currentWindow_.getWebWindow() != window) {</b>
<b class="fc">&nbsp;            currentWindow_ = new HtmlUnitWindow(window);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Set proxy for WebClient using Proxy.
&nbsp;     *
&nbsp;     * @param proxy The proxy preferences.
&nbsp;     */
&nbsp;    public void setProxySettings(final Proxy proxy) {
<b class="pc">&nbsp;        if (proxy == null || proxy.getProxyType() == Proxy.ProxyType.UNSPECIFIED) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        switch (proxy.getProxyType()) {</b>
&nbsp;            case MANUAL:
<b class="fc">&nbsp;                final List&lt;String&gt; noProxyHosts = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;                final String noProxy = proxy.getNoProxy();</b>
<b class="pc">&nbsp;                if (noProxy != null &amp;&amp; !noProxy.isEmpty()) {</b>
<b class="fc">&nbsp;                    final String[] hosts = noProxy.split(&quot;,&quot;);</b>
<b class="fc">&nbsp;                    for (final String host : hosts) {</b>
<b class="pc">&nbsp;                        if (host.trim().length() &gt; 0) {</b>
<b class="fc">&nbsp;                            noProxyHosts.add(host.trim());</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                final String httpProxy = proxy.getHttpProxy();</b>
<b class="pc">&nbsp;                if (httpProxy != null &amp;&amp; !httpProxy.isEmpty()) {</b>
<b class="fc">&nbsp;                    String host = httpProxy;</b>
<b class="fc">&nbsp;                    int port = 0;</b>
&nbsp;
<b class="fc">&nbsp;                    final int index = httpProxy.indexOf(&quot;:&quot;);</b>
<b class="fc">&nbsp;                    if (index != -1) {</b>
<b class="fc">&nbsp;                        host = httpProxy.substring(0, index);</b>
<b class="fc">&nbsp;                        port = Integer.parseInt(httpProxy.substring(index + 1));</b>
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    setHTTPProxy(host, port, noProxyHosts);</b>
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                final String socksProxy = proxy.getSocksProxy();</b>
<b class="pc">&nbsp;                if (socksProxy != null &amp;&amp; !socksProxy.isEmpty()) {</b>
<b class="fc">&nbsp;                    String host = socksProxy;</b>
<b class="fc">&nbsp;                    int port = 0;</b>
&nbsp;
<b class="fc">&nbsp;                    final int index = socksProxy.indexOf(&quot;:&quot;);</b>
<b class="fc">&nbsp;                    if (index != -1) {</b>
<b class="fc">&nbsp;                        host = socksProxy.substring(0, index);</b>
<b class="fc">&nbsp;                        port = Integer.parseInt(socksProxy.substring(index + 1));</b>
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    setSocksProxy(host, port, noProxyHosts);</b>
&nbsp;                }
&nbsp;
&nbsp;                // sslProxy is not supported/implemented
&nbsp;                // ftpProxy is not supported/implemented
&nbsp;
<b class="fc">&nbsp;                break;</b>
&nbsp;
&nbsp;            case PAC:
<b class="fc">&nbsp;                final String pac = proxy.getProxyAutoconfigUrl();</b>
<b class="pc">&nbsp;                if (pac != null &amp;&amp; !pac.isEmpty()) {</b>
<b class="fc">&nbsp;                    setAutoProxy(pac);</b>
&nbsp;                }
<b class="fc">&nbsp;                break;</b>
&nbsp;
&nbsp;            default:
&nbsp;                break;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets HTTP proxy for WebClient.
&nbsp;     *
&nbsp;     * @param host The hostname of HTTP proxy
&nbsp;     * @param port The port of HTTP proxy, 0 means HTTP proxy w/o port
&nbsp;     */
&nbsp;    public void setProxy(final String host, final int port) {
<b class="fc">&nbsp;        setHTTPProxy(host, port, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets HTTP proxy for WebClient with bypass proxy hosts.
&nbsp;     *
&nbsp;     * @param host         The hostname of HTTP proxy
&nbsp;     * @param port         The port of HTTP proxy, 0 means HTTP proxy w/o port
&nbsp;     * @param noProxyHosts The list of hosts which need to bypass HTTP proxy
&nbsp;     */
&nbsp;    public void setHTTPProxy(final String host, final int port, final List&lt;String&gt; noProxyHosts) {
<b class="fc">&nbsp;        final ProxyConfig proxyConfig = new ProxyConfig();</b>
<b class="fc">&nbsp;        proxyConfig.setProxyHost(host);</b>
<b class="fc">&nbsp;        proxyConfig.setProxyPort(port);</b>
<b class="fc">&nbsp;        if (noProxyHosts != null &amp;&amp; noProxyHosts.size() &gt; 0) {</b>
<b class="fc">&nbsp;            for (final String noProxyHost : noProxyHosts) {</b>
<b class="fc">&nbsp;                proxyConfig.addHostsToProxyBypass(noProxyHost);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        getWebClient().getOptions().setProxyConfig(proxyConfig);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets SOCKS proxy for WebClient.
&nbsp;     *
&nbsp;     * @param host The hostname of SOCKS proxy
&nbsp;     * @param port The port of SOCKS proxy, 0 means HTTP proxy w/o port
&nbsp;     */
&nbsp;    public void setSocksProxy(final String host, final int port) {
<b class="fc">&nbsp;        setSocksProxy(host, port, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets SOCKS proxy for WebClient with bypass proxy hosts.
&nbsp;     *
&nbsp;     * @param host         The hostname of SOCKS proxy
&nbsp;     * @param port         The port of SOCKS proxy, 0 means HTTP proxy w/o port
&nbsp;     * @param noProxyHosts The list of hosts which need to bypass SOCKS proxy
&nbsp;     */
&nbsp;    public void setSocksProxy(final String host, final int port, final List&lt;String&gt; noProxyHosts) {
<b class="fc">&nbsp;        final ProxyConfig proxyConfig = new ProxyConfig();</b>
<b class="fc">&nbsp;        proxyConfig.setProxyHost(host);</b>
<b class="fc">&nbsp;        proxyConfig.setProxyPort(port);</b>
<b class="fc">&nbsp;        proxyConfig.setSocksProxy(true);</b>
<b class="fc">&nbsp;        if (noProxyHosts != null &amp;&amp; noProxyHosts.size() &gt; 0) {</b>
<b class="fc">&nbsp;            for (final String noProxyHost : noProxyHosts) {</b>
<b class="fc">&nbsp;                proxyConfig.addHostsToProxyBypass(noProxyHost);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        getWebClient().getOptions().setProxyConfig(proxyConfig);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets the {@link Executor} to be used for submitting async tasks to. You have
&nbsp;     * to close this manually on {@link #quit()}
&nbsp;     *
&nbsp;     * @param executor the {@link Executor} to use
&nbsp;     */
&nbsp;    public void setExecutor(final Executor executor) {
<b class="pc">&nbsp;        if (executor == null) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;executor cannot be null&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        this.executor_ = executor;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Sets Proxy Autoconfiguration URL for WebClient.
&nbsp;     *
&nbsp;     * @param autoProxyUrl The Proxy Autoconfiguration URL
&nbsp;     */
&nbsp;    public void setAutoProxy(final String autoProxyUrl) {
<b class="fc">&nbsp;        final ProxyConfig proxyConfig = new ProxyConfig();</b>
<b class="fc">&nbsp;        proxyConfig.setProxyAutoConfigUrl(autoProxyUrl);</b>
<b class="fc">&nbsp;        getWebClient().getOptions().setProxyConfig(proxyConfig);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Capabilities getCapabilities() {
<b class="fc">&nbsp;        final DesiredCapabilities capabilities = new DesiredCapabilities(HTMLUNIT.browserName(), &quot;&quot;, Platform.ANY);</b>
&nbsp;
<b class="fc">&nbsp;        capabilities.setPlatform(Platform.getCurrent());</b>
<b class="fc">&nbsp;        capabilities.setVersion(Version.getProductVersion());</b>
&nbsp;
<b class="fc">&nbsp;        capabilities.setCapability(HtmlUnitDriver.JAVASCRIPT_ENABLED, isJavascriptEnabled());</b>
<b class="fc">&nbsp;        return capabilities;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void get(final String url) {
&nbsp;        final URL fullUrl;
&nbsp;        try {
&nbsp;            // this takes care of data: and about:
<b class="fc">&nbsp;            fullUrl = UrlUtils.toUrlUnsafe(url);</b>
<b class="fc">&nbsp;        }</b>
<b class="nc">&nbsp;        catch (final Exception e) {</b>
<b class="nc">&nbsp;            throw new WebDriverException(e);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        runAsync(() -&gt; get(fullUrl));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Allows HtmlUnit&#39;s about:blank to be loaded in the constructor, and may be
&nbsp;     * useful for other tests?
&nbsp;     *
&nbsp;     * @param fullUrl The URL to visit
&nbsp;     */
&nbsp;    protected void get(final URL fullUrl) {
<b class="fc">&nbsp;        getAlert().close();</b>
<b class="fc">&nbsp;        getAlert().setAutoAccept(false);</b>
&nbsp;        try {
&nbsp;            // we can&#39;t use webClient.getPage(url) here because selenium has a different
&nbsp;            // idea of the current window and we like to load into to selenium current one
<b class="fc">&nbsp;            final BrowserVersion browser = getBrowserVersion();</b>
<b class="fc">&nbsp;            final WebRequest request = new WebRequest(fullUrl, browser.getHtmlAcceptHeader(),</b>
<b class="fc">&nbsp;                    browser.getAcceptEncodingHeader());</b>
<b class="fc">&nbsp;            request.setCharset(StandardCharsets.UTF_8);</b>
<b class="fc">&nbsp;            getWebClient().getPage(getCurrentWindow().getWebWindow().getTopWindow(), request);</b>
&nbsp;
&nbsp;            // A &quot;get&quot; works over the entire page
<b class="fc">&nbsp;            setCurrentWindow(getCurrentWindow().getWebWindow().getTopWindow());</b>
<b class="fc">&nbsp;        }</b>
<b class="nc">&nbsp;        catch (final UnknownHostException e) {</b>
<b class="nc">&nbsp;            final WebWindow currentTopWebWindow = getCurrentWindow().getWebWindow().getTopWindow();</b>
<b class="nc">&nbsp;            final UnexpectedPage unexpectedPage = new UnexpectedPage(new StringWebResponse(&quot;Unknown host&quot;, fullUrl),</b>
<b class="nc">&nbsp;                    currentTopWebWindow);</b>
<b class="nc">&nbsp;            currentTopWebWindow.setEnclosedPage(unexpectedPage);</b>
&nbsp;        }
<b class="nc">&nbsp;        catch (final ConnectException e) {</b>
&nbsp;            // This might be expected
&nbsp;        }
<b class="nc">&nbsp;        catch (final SocketTimeoutException e) {</b>
<b class="nc">&nbsp;            throw new TimeoutException(e);</b>
&nbsp;        }
<b class="fc">&nbsp;        catch (final NoSuchSessionException e) {</b>
<b class="fc">&nbsp;            throw e;</b>
&nbsp;        }
<b class="fc">&nbsp;        catch (final NoSuchWindowException e) {</b>
<b class="fc">&nbsp;            throw e;</b>
&nbsp;        }
<b class="nc">&nbsp;        catch (final SSLHandshakeException e) {</b>
&nbsp;            return;
&nbsp;        }
<b class="fc">&nbsp;        catch (final Exception e) {</b>
<b class="fc">&nbsp;            throw new WebDriverException(e);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        resetKeyboardAndMouseState();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void resetKeyboardAndMouseState() {
<b class="fc">&nbsp;        keyboard_ = new HtmlUnitKeyboard(this);</b>
<b class="fc">&nbsp;        mouse_ = new HtmlUnitMouse(this, keyboard_);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getCurrentUrl() {
<b class="fc">&nbsp;        getWebClient(); // check that session is active</b>
<b class="fc">&nbsp;        final Page page = getCurrentWindow().getWebWindow().getTopWindow().getEnclosedPage();</b>
<b class="pc">&nbsp;        if (page == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        final URL url = page.getUrl();</b>
<b class="pc">&nbsp;        if (url == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        return url.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getTitle() {
<b class="fc">&nbsp;        alert_.ensureUnlocked();</b>
<b class="fc">&nbsp;        Page page = getCurrentWindow().lastPage();</b>
<b class="pc">&nbsp;        if (!(page instanceof HtmlPage)) {</b>
<b class="nc">&nbsp;            return null; // no page so there is no title</b>
&nbsp;        }
<b class="pc">&nbsp;        if (getCurrentWindow().getWebWindow() instanceof FrameWindow) {</b>
<b class="nc">&nbsp;            page = getCurrentWindow().getWebWindow().getTopWindow().getEnclosedPage();</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return ((HtmlPage) page).getTitleText();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public WebElement findElement(final By by) {
<b class="fc">&nbsp;        alert_.ensureUnlocked();</b>
<b class="fc">&nbsp;        return implicitlyWaitFor(() -&gt; elementFinder_.findElement(this, by));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;WebElement&gt; findElements(final By by) {
<b class="fc">&nbsp;        final long implicitWait = options_.timeouts().getImplicitWaitTimeout().toMillis();</b>
<b class="pc">&nbsp;        if (implicitWait &lt; sleepTime) {</b>
<b class="fc">&nbsp;            return elementFinder_.findElements(this, by);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final long end = System.currentTimeMillis() + implicitWait;</b>
&nbsp;        List&lt;WebElement&gt; found;
<b class="nc">&nbsp;        do {</b>
<b class="nc">&nbsp;            found = elementFinder_.findElements(this, by);</b>
<b class="nc">&nbsp;            if (!found.isEmpty()) {</b>
<b class="nc">&nbsp;                return found;</b>
&nbsp;            }
<b class="nc">&nbsp;            sleepQuietly(sleepTime);</b>
&nbsp;        }
<b class="nc">&nbsp;        while (System.currentTimeMillis() &lt; end);</b>
&nbsp;
<b class="nc">&nbsp;        return found;</b>
&nbsp;    }
&nbsp;
&nbsp;    public WebElement findElement(final HtmlUnitWebElement element, final By by) {
<b class="fc">&nbsp;        alert_.ensureUnlocked();</b>
<b class="fc">&nbsp;        return implicitlyWaitFor(() -&gt; elementFinder_.findElement(element, by));</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;WebElement&gt; findElements(final HtmlUnitWebElement element, final By by) {
<b class="fc">&nbsp;        final long implicitWait = options_.timeouts().getImplicitWaitTimeout().toMillis();</b>
<b class="pc">&nbsp;        if (implicitWait &lt; sleepTime) {</b>
<b class="fc">&nbsp;            return elementFinder_.findElements(element, by);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final long end = System.currentTimeMillis() + implicitWait;</b>
&nbsp;        List&lt;WebElement&gt; found;
<b class="nc">&nbsp;        do {</b>
<b class="nc">&nbsp;            found = elementFinder_.findElements(element, by);</b>
<b class="nc">&nbsp;            if (!found.isEmpty()) {</b>
<b class="nc">&nbsp;                return found;</b>
&nbsp;            }
<b class="nc">&nbsp;            sleepQuietly(sleepTime);</b>
&nbsp;        }
<b class="nc">&nbsp;        while (System.currentTimeMillis() &lt; end);</b>
&nbsp;
<b class="nc">&nbsp;        return found;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getPageSource() {
<b class="nc">&nbsp;        final Page page = getCurrentWindow().lastPage();</b>
<b class="nc">&nbsp;        if (page == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (page instanceof SgmlPage) {</b>
<b class="nc">&nbsp;            return ((SgmlPage) page).asXml();</b>
&nbsp;        }
<b class="nc">&nbsp;        final WebResponse response = page.getWebResponse();</b>
<b class="nc">&nbsp;        return response.getContentAsString();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void close() {
<b class="fc">&nbsp;        getWebClient(); // check that session is active</b>
<b class="fc">&nbsp;        if (getWebClient().getWebWindows().size() == 1) {</b>
&nbsp;            // closing the last window is equivalent to quit
<b class="fc">&nbsp;            quit();</b>
<b class="fc">&nbsp;        }</b>
&nbsp;        else {
<b class="fc">&nbsp;            final WebWindow thisWindow = getCurrentWindow().getWebWindow(); // check that the current window is active</b>
<b class="pc">&nbsp;            if (thisWindow != null) {</b>
<b class="fc">&nbsp;                alert_.close();</b>
<b class="fc">&nbsp;                ((TopLevelWindow) thisWindow.getTopWindow()).close();</b>
&nbsp;            }
<b class="pc">&nbsp;            if (getWebClient().getWebWindows().size() == 0) {</b>
<b class="nc">&nbsp;                quit();</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void quit() {
<b class="pc">&nbsp;        if (webClient_ != null) {</b>
<b class="fc">&nbsp;            alert_.close();</b>
<b class="fc">&nbsp;            webClient_.close();</b>
<b class="fc">&nbsp;            webClient_ = null;</b>
&nbsp;        }
<b class="fc">&nbsp;        defaultExecutor_.shutdown();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Set&lt;String&gt; getWindowHandles() {
<b class="fc">&nbsp;        final Set&lt;String&gt; allHandles = new HashSet&lt;&gt;();</b>
<b class="fc">&nbsp;        for (final WebWindow window : getWebClient().getTopLevelWindows()) {</b>
<b class="fc">&nbsp;            allHandles.add(String.valueOf(System.identityHashCode(window)));</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return allHandles;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getWindowHandle() {
<b class="fc">&nbsp;        final WebWindow topWindow = getCurrentWindow().getWebWindow().getTopWindow();</b>
<b class="pc">&nbsp;        if (topWindow.isClosed()) {</b>
<b class="nc">&nbsp;            throw new NoSuchWindowException(&quot;Window is closed&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return String.valueOf(System.identityHashCode(topWindow));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Object executeScript(String script, final Object... args) {
<b class="fc">&nbsp;        final HtmlPage page = getPageToInjectScriptInto();</b>
&nbsp;
<b class="fc">&nbsp;        script = &quot;function() {&quot; + script + &quot;\n};&quot;;</b>
<b class="fc">&nbsp;        ScriptResult result = page.executeJavaScript(script);</b>
<b class="fc">&nbsp;        final Object function = result.getJavaScriptResult();</b>
&nbsp;
<b class="fc">&nbsp;        final Object[] parameters = convertScriptArgs(page, args);</b>
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            result = page.executeJavaScriptFunction(function, getCurrentWindow().getWebWindow().getScriptableObject(),</b>
<b class="fc">&nbsp;                    parameters, page.getDocumentElement());</b>
&nbsp;
<b class="fc">&nbsp;            return parseNativeJavascriptResult(result);</b>
&nbsp;        }
<b class="nc">&nbsp;        catch (final Throwable ex) {</b>
<b class="nc">&nbsp;            throw new WebDriverException(ex);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Object executeAsyncScript(final String script, Object... args) {
<b class="fc">&nbsp;        final HtmlPage page = getPageToInjectScriptInto();</b>
<b class="fc">&nbsp;        args = convertScriptArgs(page, args);</b>
&nbsp;
<b class="fc">&nbsp;        asyncScriptExecutor_ = new AsyncScriptExecutor(page, options_.timeouts().getScriptTimeout().toMillis());</b>
&nbsp;        try {
<b class="fc">&nbsp;            final Object result = asyncScriptExecutor_.execute(script, args);</b>
&nbsp;
<b class="nc">&nbsp;            alert_.ensureUnlocked();</b>
<b class="nc">&nbsp;            return parseNativeJavascriptResult(result);</b>
&nbsp;        }
<b class="fc">&nbsp;        finally {</b>
<b class="fc">&nbsp;            asyncScriptExecutor_ = null;</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private Object[] convertScriptArgs(final HtmlPage page, final Object[] args) {
<b class="fc">&nbsp;        final Object scope = page.getEnclosingWindow().getScriptableObject();</b>
&nbsp;
<b class="pc">&nbsp;        if (!(scope instanceof Scriptable)) {</b>
<b class="nc">&nbsp;            return args;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        final Object[] parameters = new Object[args.length];</b>
<b class="fc">&nbsp;        Context.enter();</b>
&nbsp;        try {
<b class="pc">&nbsp;            for (int i = 0; i &lt; args.length; i++) {</b>
<b class="nc">&nbsp;                parameters[i] = parseArgumentIntoJavascriptParameter((Scriptable) scope, args[i]);</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
<b class="nc">&nbsp;        finally {</b>
<b class="fc">&nbsp;            Context.exit();</b>
<b class="nc">&nbsp;        }</b>
<b class="fc">&nbsp;        return parameters;</b>
&nbsp;    }
&nbsp;
&nbsp;    private HtmlPage getPageToInjectScriptInto() {
<b class="pc">&nbsp;        if (!isJavascriptEnabled()) {</b>
<b class="nc">&nbsp;            throw new UnsupportedOperationException(&quot;Javascript is not enabled for this HtmlUnitDriver instance&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        final Page lastPage = getCurrentWindow().lastPage();</b>
<b class="pc">&nbsp;        if (!(lastPage instanceof HtmlPage)) {</b>
<b class="nc">&nbsp;            throw new UnsupportedOperationException(&quot;Cannot execute JS against a plain text page&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return (HtmlPage) lastPage;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Object parseArgumentIntoJavascriptParameter(final Scriptable scope, Object arg) {
<b class="nc">&nbsp;        while (arg instanceof WrapsElement) {</b>
<b class="nc">&nbsp;            arg = ((WrapsElement) arg).getWrappedElement();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!(arg instanceof HtmlUnitWebElement</b>
<b class="nc">&nbsp;                || arg instanceof HtmlElement</b>
<b class="nc">&nbsp;                || arg instanceof Number // special case the underlying type</b>
<b class="nc">&nbsp;                || arg instanceof String</b>
<b class="nc">&nbsp;                || arg instanceof Boolean</b>
<b class="nc">&nbsp;                || arg.getClass().isArray()</b>
<b class="nc">&nbsp;                || arg instanceof Collection&lt;?&gt; || arg instanceof Map&lt;?, ?&gt;)) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(</b>
<b class="nc">&nbsp;                    &quot;Argument must be a string, number, boolean or WebElement: &quot; + arg + &quot; (&quot; + arg.getClass() + &quot;)&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (arg instanceof HtmlUnitWebElement) {</b>
<b class="nc">&nbsp;            final HtmlUnitWebElement webElement = (HtmlUnitWebElement) arg;</b>
<b class="nc">&nbsp;            assertElementNotStale(webElement.getElement());</b>
<b class="nc">&nbsp;            return webElement.getElement().getScriptableObject();</b>
&nbsp;
&nbsp;        }
<b class="nc">&nbsp;        else if (arg instanceof HtmlElement) {</b>
<b class="nc">&nbsp;            final HtmlElement element = (HtmlElement) arg;</b>
<b class="nc">&nbsp;            assertElementNotStale(element);</b>
<b class="nc">&nbsp;            return element.getScriptableObject();</b>
&nbsp;
&nbsp;        }
<b class="nc">&nbsp;        else if (arg instanceof Collection&lt;?&gt;) {</b>
<b class="nc">&nbsp;            final List&lt;Object&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (final Object o : (Collection&lt;?&gt;) arg) {</b>
<b class="nc">&nbsp;                list.add(parseArgumentIntoJavascriptParameter(scope, o));</b>
&nbsp;            }
<b class="nc">&nbsp;            return Context.getCurrentContext().newArray(scope, list.toArray());</b>
&nbsp;
&nbsp;        }
<b class="nc">&nbsp;        else if (arg.getClass().isArray()) {</b>
<b class="nc">&nbsp;            final List&lt;Object&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (final Object o : (Object[]) arg) {</b>
<b class="nc">&nbsp;                list.add(parseArgumentIntoJavascriptParameter(scope, o));</b>
&nbsp;            }
<b class="nc">&nbsp;            return Context.getCurrentContext().newArray(scope, list.toArray());</b>
&nbsp;
&nbsp;        }
<b class="nc">&nbsp;        else if (arg instanceof Map&lt;?, ?&gt;) {</b>
<b class="nc">&nbsp;            final Map&lt;?, ?&gt; argmap = (Map&lt;?, ?&gt;) arg;</b>
<b class="nc">&nbsp;            final Scriptable map = Context.getCurrentContext().newObject(scope);</b>
<b class="nc">&nbsp;            for (final Map.Entry&lt;?, ?&gt; entry : argmap.entrySet()) {</b>
<b class="nc">&nbsp;                map.put((String) entry.getKey(), map, parseArgumentIntoJavascriptParameter(scope, entry.getValue()));</b>
&nbsp;            }
<b class="nc">&nbsp;            return map;</b>
&nbsp;
&nbsp;        }
&nbsp;        else {
<b class="nc">&nbsp;            return arg;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    protected void assertElementNotStale(final DomElement element) {
<b class="fc">&nbsp;        final SgmlPage elementPage = element.getPage();</b>
<b class="fc">&nbsp;        final Page lastPage = getCurrentWindow().lastPage();</b>
&nbsp;
<b class="pc">&nbsp;        if (!lastPage.equals(elementPage)) {</b>
<b class="nc">&nbsp;            throw new StaleElementReferenceException(</b>
<b class="nc">&nbsp;                    &quot;Element appears to be stale. Did you navigate away from the page that contained it? &quot;</b>
&nbsp;                            + &quot; And is the current window focussed the same as the one holding this element?&quot;);
&nbsp;        }
&nbsp;
&nbsp;        // We need to walk the DOM to determine if the element is actually attached
<b class="fc">&nbsp;        DomNode parentElement = element;</b>
<b class="pc">&nbsp;        while (parentElement != null &amp;&amp; !(parentElement instanceof SgmlPage)) {</b>
<b class="fc">&nbsp;            parentElement = parentElement.getParentNode();</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (parentElement == null) {</b>
<b class="nc">&nbsp;            throw new StaleElementReferenceException(&quot;The element seems to be disconnected from the DOM. &quot;</b>
&nbsp;                    + &quot; This means that a user cannot interact with it.&quot;);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public HtmlUnitKeyboard getKeyboard() {
<b class="fc">&nbsp;        return keyboard_;</b>
&nbsp;    }
&nbsp;
&nbsp;    public HtmlUnitMouse getMouse() {
<b class="fc">&nbsp;        return mouse_;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected interface JavaScriptResultsCollection {
&nbsp;        int getLength();
&nbsp;
&nbsp;        Object item(int index);
&nbsp;    }
&nbsp;
&nbsp;    private Object parseNativeJavascriptResult(final Object result) {
&nbsp;        final Object value;
<b class="pc">&nbsp;        if (result instanceof ScriptResult) {</b>
<b class="fc">&nbsp;            value = ((ScriptResult) result).getJavaScriptResult();</b>
<b class="fc">&nbsp;        }</b>
&nbsp;        else {
<b class="nc">&nbsp;            value = result;</b>
&nbsp;        }
<b class="pc">&nbsp;        if (value instanceof HTMLElement) {</b>
<b class="nc">&nbsp;            return toWebElement(((HTMLElement) value).getDomNodeOrDie());</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (value instanceof DocumentProxy) {</b>
<b class="nc">&nbsp;            final Element element = ((DocumentProxy) value).getDelegee().getDocumentElement();</b>
<b class="nc">&nbsp;            if (element instanceof HTMLElement) {</b>
<b class="nc">&nbsp;                return toWebElement(((HTMLElement) element).getDomNodeOrDie());</b>
&nbsp;            }
<b class="nc">&nbsp;            throw new WebDriverException(&quot;Do not know how to coerce to an HTMLElement: &quot; + element);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (value instanceof Number) {</b>
<b class="fc">&nbsp;            final Number n = (Number) value;</b>
<b class="fc">&nbsp;            final String s = n.toString();</b>
<b class="pc">&nbsp;            if (!s.contains(&quot;.&quot;) || s.endsWith(&quot;.0&quot;)) { // how safe it is? enough for the unit tests!</b>
<b class="fc">&nbsp;                return n.longValue();</b>
&nbsp;            }
<b class="nc">&nbsp;            return n.doubleValue();</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (value instanceof NativeObject) {</b>
&nbsp;            @SuppressWarnings(&quot;unchecked&quot;)
<b class="nc">&nbsp;            final Map&lt;String, Object&gt; map = new HashMap&lt;&gt;((NativeObject) value);</b>
<b class="nc">&nbsp;            for (final Entry&lt;String, Object&gt; e : map.entrySet()) {</b>
<b class="nc">&nbsp;                e.setValue(parseNativeJavascriptResult(e.getValue()));</b>
&nbsp;            }
<b class="nc">&nbsp;            return map;</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (value instanceof Location) {</b>
<b class="nc">&nbsp;            return convertLocationToMap((Location) value);</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (value instanceof NativeArray) {</b>
<b class="nc">&nbsp;            final NativeArray array = (NativeArray) value;</b>
&nbsp;
<b class="nc">&nbsp;            final JavaScriptResultsCollection collection = new JavaScriptResultsCollection() {</b>
&nbsp;                @Override
&nbsp;                public int getLength() {
<b class="nc">&nbsp;                    return (int) array.getLength();</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public Object item(final int index) {
<b class="nc">&nbsp;                    return array.get(index);</b>
&nbsp;                }
&nbsp;            };
&nbsp;
<b class="nc">&nbsp;            return parseJavascriptResultsList(collection);</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (value instanceof HTMLCollection) {</b>
<b class="nc">&nbsp;            final HTMLCollection array = (HTMLCollection) value;</b>
&nbsp;
<b class="nc">&nbsp;            final JavaScriptResultsCollection collection = new JavaScriptResultsCollection() {</b>
&nbsp;
&nbsp;                @Override
&nbsp;                public int getLength() {
<b class="nc">&nbsp;                    return array.getLength();</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public Object item(final int index) {
<b class="nc">&nbsp;                    return array.get(index);</b>
&nbsp;                }
&nbsp;            };
&nbsp;
<b class="nc">&nbsp;            return parseJavascriptResultsList(collection);</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (value instanceof IdScriptableObject &amp;&amp; value.getClass().getSimpleName().equals(&quot;NativeDate&quot;)) {</b>
&nbsp;
<b class="nc">&nbsp;            final long l = ((Number) getPrivateField(value, &quot;date&quot;)).longValue();</b>
<b class="nc">&nbsp;            return Instant.ofEpochMilli(l).toString();</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (Undefined.isUndefined(value)) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return value;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Object getPrivateField(final Object o, final String fieldName) {
&nbsp;        try {
<b class="nc">&nbsp;            final Field field = o.getClass().getDeclaredField(fieldName);</b>
<b class="nc">&nbsp;            field.setAccessible(true);</b>
<b class="nc">&nbsp;            return field.get(o);</b>
&nbsp;        }
<b class="nc">&nbsp;        catch (final Exception e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static Map&lt;String, Object&gt; convertLocationToMap(final Location location) {
<b class="nc">&nbsp;        final Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        map.put(&quot;protocol&quot;, location.getProtocol());</b>
<b class="nc">&nbsp;        map.put(&quot;host&quot;, location.getHost());</b>
<b class="nc">&nbsp;        map.put(&quot;hostname&quot;, location.getHostname());</b>
<b class="nc">&nbsp;        map.put(&quot;port&quot;, location.getPort());</b>
<b class="nc">&nbsp;        map.put(&quot;pathname&quot;, location.getPathname());</b>
<b class="nc">&nbsp;        map.put(&quot;search&quot;, location.getSearch());</b>
<b class="nc">&nbsp;        map.put(&quot;hash&quot;, location.getHash());</b>
<b class="nc">&nbsp;        map.put(&quot;href&quot;, location.getHref());</b>
<b class="nc">&nbsp;        return map;</b>
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;Object&gt; parseJavascriptResultsList(final JavaScriptResultsCollection array) {
<b class="nc">&nbsp;        final List&lt;Object&gt; list = new ArrayList&lt;&gt;(array.getLength());</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; array.getLength(); ++i) {</b>
<b class="nc">&nbsp;            list.add(parseNativeJavascriptResult(array.item(i)));</b>
&nbsp;        }
<b class="nc">&nbsp;        return list;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TargetLocator switchTo() {
<b class="fc">&nbsp;        return targetLocator_;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Navigation navigate() {
<b class="fc">&nbsp;        return new HtmlUnitNavigation();</b>
&nbsp;    }
&nbsp;
&nbsp;    protected HtmlUnitWebElement toWebElement(final DomElement element) {
<b class="fc">&nbsp;        return getElementsMap().addIfAbsent(this, element);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isJavascriptEnabled() {
<b class="fc">&nbsp;        return getWebClient().getOptions().isJavaScriptEnabled();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setJavascriptEnabled(final boolean enableJavascript) {
<b class="fc">&nbsp;        getWebClient().getOptions().setJavaScriptEnabled(enableJavascript);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isDownloadImages() {
<b class="nc">&nbsp;        return getWebClient().getOptions().isDownloadImages();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setDownloadImages(final boolean downloadImages) {
<b class="fc">&nbsp;        getWebClient().getOptions().setDownloadImages(downloadImages);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setAcceptInsecureCerts(final boolean accept) {
<b class="fc">&nbsp;        getWebClient().getOptions().setUseInsecureSSL(accept);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isAcceptInsecureCerts() {
<b class="nc">&nbsp;        return getWebClient().getOptions().isUseInsecureSSL();</b>
&nbsp;    }
&nbsp;
&nbsp;    protected &lt;X&gt; X implicitlyWaitFor(final Callable&lt;X&gt; condition) {
<b class="fc">&nbsp;        final long implicitWait = options_.timeouts().getImplicitWaitTimeout().toMillis();</b>
&nbsp;
<b class="pc">&nbsp;        if (implicitWait &lt; sleepTime) {</b>
&nbsp;            try {
<b class="fc">&nbsp;                return condition.call();</b>
&nbsp;            }
<b class="fc">&nbsp;            catch (final RuntimeException e) {</b>
<b class="fc">&nbsp;                throw e;</b>
&nbsp;            }
<b class="nc">&nbsp;            catch (final Exception e) {</b>
<b class="nc">&nbsp;                throw new WebDriverException(e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        final long end = System.currentTimeMillis() + implicitWait;</b>
<b class="nc">&nbsp;        Exception lastException = null;</b>
&nbsp;
<b class="nc">&nbsp;        do {</b>
<b class="nc">&nbsp;            X toReturn = null;</b>
&nbsp;            try {
<b class="nc">&nbsp;                toReturn = condition.call();</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            catch (final Exception e) {</b>
<b class="nc">&nbsp;                lastException = e;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (toReturn instanceof Boolean &amp;&amp; !(Boolean) toReturn) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (toReturn != null) {</b>
<b class="nc">&nbsp;                return toReturn;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            sleepQuietly(sleepTime);</b>
&nbsp;        }
<b class="nc">&nbsp;        while (System.currentTimeMillis() &lt; end);</b>
&nbsp;
<b class="nc">&nbsp;        if (lastException != null) {</b>
<b class="nc">&nbsp;            if (lastException instanceof RuntimeException) {</b>
<b class="nc">&nbsp;                throw (RuntimeException) lastException;</b>
&nbsp;            }
<b class="nc">&nbsp;            throw new WebDriverException(lastException);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public WebClient getWebClient() {
<b class="pc">&nbsp;        if (webClient_ == null) {</b>
<b class="nc">&nbsp;            throw new NoSuchSessionException(&quot;Session is closed&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return webClient_;</b>
&nbsp;    }
&nbsp;
&nbsp;    public HtmlUnitWindow getCurrentWindow() {
<b class="fc">&nbsp;        if (webClient_ == null || currentWindow_ == null) {</b>
<b class="fc">&nbsp;            throw new NoSuchSessionException(&quot;Session is closed&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (currentWindow_.getWebWindow().isClosed()) {</b>
<b class="fc">&nbsp;            throw new NoSuchWindowException(&quot;Window is closed&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        return currentWindow_;</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private class HtmlUnitNavigation implements Navigation {</b>
&nbsp;
&nbsp;        @Override
&nbsp;        public void back() {
<b class="fc">&nbsp;            runAsync(() -&gt; {</b>
&nbsp;                try {
<b class="fc">&nbsp;                    getCurrentWindow().getWebWindow().getHistory().back();</b>
<b class="fc">&nbsp;                }</b>
<b class="nc">&nbsp;                catch (final IOException e) {</b>
<b class="nc">&nbsp;                    throw new WebDriverException(e);</b>
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void forward() {
<b class="fc">&nbsp;            runAsync(() -&gt; {</b>
&nbsp;                try {
<b class="fc">&nbsp;                    getCurrentWindow().getWebWindow().getHistory().forward();</b>
<b class="fc">&nbsp;                }</b>
<b class="nc">&nbsp;                catch (final IOException e) {</b>
<b class="nc">&nbsp;                    throw new WebDriverException(e);</b>
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void to(final String url) {
<b class="nc">&nbsp;            get(url);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void to(final URL url) {
<b class="nc">&nbsp;            get(url);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void refresh() {
<b class="nc">&nbsp;            if (getCurrentWindow().lastPage() instanceof HtmlPage) {</b>
<b class="nc">&nbsp;                runAsync(() -&gt; {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        ((HtmlPage) getCurrentWindow().lastPage()).refresh();</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    catch (final SocketTimeoutException e) {</b>
<b class="nc">&nbsp;                        throw new TimeoutException(e);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    catch (final IOException e) {</b>
<b class="nc">&nbsp;                        throw new WebDriverException(e);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Options manage() {
<b class="fc">&nbsp;        return options_;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void sleepQuietly(final long ms) {
&nbsp;        try {
<b class="nc">&nbsp;            Thread.sleep(ms);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        catch (final InterruptedException ignored) {</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    private enum PageLoadStrategy {</b>
<b class="fc">&nbsp;        NORMAL, EAGER, NONE</b>
&nbsp;    }
&nbsp;
&nbsp;    protected static class ElementsMap {
&nbsp;        private final Map&lt;SgmlPage, Map&lt;DomElement, HtmlUnitWebElement&gt;&gt; elementsMapByPage_;
&nbsp;        private int idCounter_;
&nbsp;
<b class="fc">&nbsp;        public ElementsMap() {</b>
<b class="fc">&nbsp;            elementsMapByPage_ = new WeakHashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            idCounter_ = 0;</b>
&nbsp;        }
&nbsp;
&nbsp;        public HtmlUnitWebElement addIfAbsent(final HtmlUnitDriver driver, final DomElement element) {
<b class="fc">&nbsp;            final Map&lt;DomElement, HtmlUnitWebElement&gt; pageMap = elementsMapByPage_.computeIfAbsent(element.getPage(),</b>
<b class="fc">&nbsp;                    k -&gt; new HashMap&lt;&gt;());</b>
&nbsp;
<b class="fc">&nbsp;            HtmlUnitWebElement e = pageMap.get(element);</b>
<b class="fc">&nbsp;            if (e == null) {</b>
<b class="fc">&nbsp;                idCounter_++;</b>
<b class="fc">&nbsp;                e = new HtmlUnitWebElement(driver, idCounter_, element);</b>
<b class="fc">&nbsp;                pageMap.put(element, e);</b>
&nbsp;            }
<b class="fc">&nbsp;            return e;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void remove(final Page page) {
<b class="fc">&nbsp;            elementsMapByPage_.remove(page);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void perform(final Collection&lt;Sequence&gt; sequences) {
&nbsp;        // https://www.w3.org/TR/webdriver/#perform-actions
&nbsp;
&nbsp;        // Let input state be the result of get the input state with current session and
&nbsp;        // current top-level browsing context.
&nbsp;
&nbsp;        // Let actions by tick be the result of trying to extract an action sequence
&nbsp;        // given input state, and parameters.
<b class="fc">&nbsp;        final List&lt;List&lt;Action&gt;&gt; actionsByTick = Algorithms.extractActionSequence(sequences);</b>
&nbsp;
&nbsp;        // If the current browsing context is no longer open, return error with error
&nbsp;        // code no such window.
&nbsp;
&nbsp;        // Handle any user prompts. If this results in an error, return that error.
&nbsp;
&nbsp;        // Dispatch actions given input state, actions by tick, and current browsing
&nbsp;        // context.
&nbsp;        // If this results in an error return that error.
<b class="fc">&nbsp;        Algorithms.dispatchActions(/* inputState_, */ actionsByTick, inputProcessor_);</b>
&nbsp;
&nbsp;        // Return success with data null.
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void resetInputState() {
<b class="nc">&nbsp;        inputProcessor_ = new HtmlUnitInputProcessor(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void switchToDefaultContentOfWindow(final WebWindow window) {
<b class="fc">&nbsp;        final Page page = window.getEnclosedPage();</b>
<b class="pc">&nbsp;        if (page instanceof HtmlPage) {</b>
<b class="fc">&nbsp;            setCurrentWindow(page.getEnclosingWindow());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void openNewWindow() {
<b class="fc">&nbsp;        final WebWindow newWindow = webClient_.openWindow(UrlUtils.URL_ABOUT_BLANK, &quot;&quot;);</b>
<b class="fc">&nbsp;        currentWindow_ = new HtmlUnitWindow(newWindow);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-02 21:22</div>
</div>
</body>
</html>
